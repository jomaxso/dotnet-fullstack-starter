# Deployment Guide

This guide covers all deployment scenarios for the .NET 9 A# 5. Verify deployment
docker-compose ps
docker-compose logs frontendre Fullstack Starter, from development to production.

## üöÄ Quick Deployment Overview

| Environment | Command | Target |
|-------------|---------|--------|
| Development | `aspire run` | Local containers |
| Production | `aspire publish` ‚Üí `docker-compose up` | Docker hosts |
| Cloud | `aspire publish` + hosting packages | Kubernetes/Azure/AWS |

## üèóÔ∏è Deployment Architecture

### Local Development
- **Aspire Orchestration**: All services managed locally
- **Hot Reload**: Automatic code refresh
- **Debug Support**: Full debugging capabilities

### Production Deployment
- **Container-Based**: Docker Compose or Kubernetes
- **Stateless Services**: Horizontal scaling ready
- **Health Monitoring**: Built-in health checks

## üì¶ Building for Production

### 1. Create Production Build

```powershell
# Generate deployment manifests
aspire publish --output-path ./publish

# Generated files:
# ./publish/
# ‚îú‚îÄ‚îÄ docker-compose.yml      # Container orchestration
# ‚îú‚îÄ‚îÄ .env                    # Environment variables
# ‚îú‚îÄ‚îÄ docker-compose.override.yml # Development overrides
# ‚îî‚îÄ‚îÄ manifests/              # Kubernetes manifests (if configured)
```

### 2. Migration Bundle (Recommended)

```powershell
# Create standalone migration executable
cd src/Api.Migrations
dotnet ef migrations bundle --configuration Release --output ../publish/migrate.exe

# The bundle includes:
# - All migrations
# - Standalone executable  
# - No .NET runtime required on target
```

### 3. Optimize Container Images

```dockerfile
# Production Dockerfile example (generated by Aspire)
FROM mcr.microsoft.com/dotnet/aspire-app:9.0 AS base
WORKDIR /app
EXPOSE 8080

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
# Build steps generated automatically
```

## üê≥ Docker Deployment

### Single Server Deployment

```powershell
# 1. Copy files to server
scp -r ./publish/* user@yourserver:/opt/yourapp/

# 2. On the server, start services
ssh user@yourserver
cd /opt/yourapp
docker-compose up -d

# 3. Run migrations (if using bundles)
./migrate.exe --connection "Server=mysql;Database=yourdb;User=appuser;Password=yourpassword;"

# 4. Verify deployment
docker-compose ps
docker-compose logs -f frontend
```

### Production Docker Compose

```yaml
# Example docker-compose.production.yml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    volumes:
      - mysql_data:/var/lib/mysql
    restart: unless-stopped
    
  api:
    image: yourregistry/yourapp-api:latest
    environment:
      ConnectionStrings__DefaultConnection: ${CONNECTION_STRING}
    depends_on:
      - mysql
    restart: unless-stopped
    
  frontend:
    image: yourregistry/yourapp-frontend:latest
    ports:
      - "80:8080"
      - "443:8081"
    depends_on:
      - api
    restart: unless-stopped

volumes:
  mysql_data:
```

### Load Balancer Configuration

```nginx
# nginx.conf for load balancing
upstream api_backend {
    server api1:8080;
    server api2:8080;
    server api3:8080;
}

upstream frontend_backend {
    server frontend1:8080;
    server frontend2:8080;
}

server {
    listen 80;
    server_name yourapp.com;
    
    location /api/ {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location / {
        proxy_pass http://frontend_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## ‚ò∏Ô∏è Kubernetes Deployment

### 1. Enable Kubernetes Support

```powershell
# Add Kubernetes hosting package
dotnet add AppHost package Aspire.Hosting.Kubernetes

# Update AppHost.cs
builder.AddKubernetesEnvironment("k8s");
```

### 2. Generate Kubernetes Manifests

```powershell
aspire publish --output-path ./k8s-publish
```

### 3. Deploy to Kubernetes

```powershell
# Apply manifests
kubectl apply -f ./k8s-publish/

# Check deployment status
kubectl get pods
kubectl get services

# Scale services
kubectl scale deployment api --replicas=3
kubectl scale deployment frontend --replicas=2
```

### 4. Kubernetes Configuration Examples

```yaml
# api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api
  template:
    metadata:
      labels:
        app: api
    spec:
      containers:
      - name: api
        image: yourregistry/yourapp-api:latest
        ports:
        - containerPort: 8080
        env:
        - name: ConnectionStrings__DefaultConnection
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: connection-string
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
        readinessProbe:
          httpGet:
            path: /health/ready
            port: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: api-service
spec:
  selector:
    app: api
  ports:
  - port: 80
    targetPort: 8080
  type: ClusterIP
```

## ‚òÅÔ∏è Cloud Deployment

### Azure Container Apps

```powershell
# Install Azure CLI and Container Apps extension
az extension add --name containerapp

# Create resource group
az group create --name yourapp-rg --location eastus

# Create Container Apps environment
az containerapp env create \
  --name yourapp-env \
  --resource-group yourapp-rg \
  --location eastus

# Deploy API
az containerapp create \
  --name yourapp-api \
  --resource-group yourapp-rg \
  --environment yourapp-env \
  --image yourregistry/yourapp-api:latest \
  --target-port 8080 \
  --ingress external

# Deploy Frontend
az containerapp create \
  --name yourapp-frontend \
  --resource-group yourapp-rg \
  --environment yourapp-env \
  --image yourregistry/yourapp-frontend:latest \
  --target-port 8080 \
  --ingress external
```

### AWS ECS Deployment

```powershell
# Install AWS CLI and configure
aws configure

# Create ECS cluster
aws ecs create-cluster --cluster-name yourapp-cluster

# Create task definition
aws ecs register-task-definition --cli-input-json file://task-definition.json

# Create service
aws ecs create-service \
  --cluster yourapp-cluster \
  --service-name yourapp-service \
  --task-definition yourapp:1 \
  --desired-count 2
```

## üóÑÔ∏è Database Deployment

### Migration Strategies

#### 1. Automatic Migrations (Development)
```csharp
// Automatically applied on startup
if (app.Environment.IsDevelopment())
{
    using var scope = app.Services.CreateScope();
    var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
    await context.Database.MigrateAsync();
}
```

#### 2. Migration Bundles (Production)
```powershell
# Create bundle
dotnet ef migrations bundle --output migrate

# Deploy with bundle
./migrate --connection "YourConnectionString"
```

#### 3. Blue-Green Deployment
```powershell
# 1. Deploy new version to staging environment
docker-compose -f docker-compose.staging.yml up -d

# 2. Run migrations against staging
./migrate --connection "StagingConnectionString"

# 3. Test staging environment
curl https://staging.yourapp.com/health

# 4. Switch traffic to staging (becomes production)
# 5. Keep old production as fallback
```

### Database Security

```yaml
# Use secrets for sensitive data
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
data:
  connection-string: <base64-encoded-connection-string>
  mysql-root-password: <base64-encoded-password>
```

## üîß Environment Configuration

### Environment Variables

```bash
# Production environment variables
ASPNETCORE_ENVIRONMENT=Production
ASPNETCORE_URLS=http://+:8080

# Database
ConnectionStrings__DefaultConnection="Server=mysql;Database=yourapp;User=appuser;Password=yourpassword;"

# Logging
Logging__LogLevel__Default=Warning
Logging__LogLevel__Microsoft.AspNetCore=Warning

# Security
DataProtection__ApplicationName=YourApp
```

### Configuration Hierarchy

1. **appsettings.json** - Base configuration
2. **appsettings.{Environment}.json** - Environment-specific
3. **Environment Variables** - Container/cloud configuration
4. **Azure Key Vault / AWS Secrets** - Sensitive data

### Example Production Configuration

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "Server=${DB_HOST};Database=${DB_NAME};User=${DB_USER};Password=${DB_PASSWORD};"
  },
  "Authentication": {
    "CookieExpiration": "00:30:00"
  }
}
```

## üìä Monitoring & Health Checks

### Health Check Configuration

```csharp
// Built-in health checks
builder.Services.AddHealthChecks()
    .AddDbContextCheck<ApplicationDbContext>()
    .AddCheck("api", () => HealthCheckResult.Healthy())
    .AddCheck("external-service", async () => 
    {
        // Check external dependencies
        return HealthCheckResult.Healthy();
    });
```

### Monitoring Endpoints

```
GET /health          # Overall health
GET /health/ready    # Readiness probe
GET /health/live     # Liveness probe
```

### Production Monitoring

```yaml
# Prometheus monitoring
version: '3.8'
services:
  app:
    # Your app configuration
    
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
```

## üîÑ CI/CD Pipeline

### GitHub Actions Example

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Run tests
      run: dotnet test
      
    - name: Create migration bundle
      run: |
        cd src/Api.Migrations
        dotnet ef migrations bundle --configuration Release
        
    - name: Build containers
      run: |
        aspire publish --output-path ./publish
        
    - name: Deploy to production
      run: |
        scp -r ./publish/* ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/opt/yourapp/
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "cd /opt/yourapp && docker-compose up -d"
```

## üö® Troubleshooting

### Common Deployment Issues

#### 1. Database Connection Issues
```powershell
# Test connection
docker exec mysql mysql -u root -p -e "SHOW DATABASES;"

# Check connection string
docker logs api | grep -i connection
```

#### 2. Container Startup Issues
```powershell
# Check container logs
docker-compose logs -f api

# Check health status
curl http://localhost:8080/health
```

#### 3. Migration Issues
```powershell
# Manual migration
docker exec api dotnet ef database update

# Reset database (caution!)
docker exec mysql mysql -u root -p -e "DROP DATABASE yourapp; CREATE DATABASE yourapp;"
```

### Performance Tuning

```yaml
# Docker resource limits
services:
  api:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
```

### Security Checklist

- [ ] Use HTTPS in production
- [ ] Secure database credentials
- [ ] Enable HSTS headers
- [ ] Configure firewall rules
- [ ] Regular security updates
- [ ] Monitor access logs
- [ ] Backup strategy in place

## üìã Deployment Checklist

### Pre-Deployment
- [ ] All tests passing
- [ ] Security scan completed
- [ ] Performance testing done
- [ ] Backup created
- [ ] Rollback plan ready

### During Deployment
- [ ] Monitor application logs
- [ ] Check health endpoints
- [ ] Verify database migrations
- [ ] Test critical user flows
- [ ] Monitor system resources

### Post-Deployment
- [ ] Application responding correctly
- [ ] All services healthy
- [ ] Performance metrics normal
- [ ] User acceptance testing
- [ ] Documentation updated
